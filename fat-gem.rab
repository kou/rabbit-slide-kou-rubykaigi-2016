= Fat gem

: author
   Kouhei Sutou
: institution
   ClearCode Inc.
: content-source
   RubyKaigi 2016
: date
   2016-09-08
: allotted-time
   5m
: theme
   .

= Fat gem?\n(('note:fat gemã¨ã¯'))

  * Gem includes built binaries\n
    (('note:ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ãƒã‚¤ãƒŠãƒªãƒ¼å…¥ã‚Šgem'))
    * (('note:(Mainly)')) Provided for Windows users\n
      (('note:ä¸»ã«Windowsãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã«æä¾›'))
  * (('wait'))Windows users don't need C compilerğŸ˜¼\n
    (('note:Windowsãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯Cã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ¼ã‚’ç”¨æ„ã—ãªãã¦ã‚ˆã„'))

= Why fat gem is needed?\n(('note:ã©ã†ã—ã¦fat gemãŒå¿…è¦ãªã®ã‹'))

  * Most Windows users don't have C compiler\n
    (('note:å¤šãã®Windowsãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ¼ã‚’æŒã£ã¦ã„ãªã„'))

= How to create fat gem\n(('note:fat gemã®ä½œã‚Šæ–¹'))

  * Bundle binaries to gem\n
    (('note:gemã«ãƒã‚¤ãƒŠãƒªãƒ¼ã‚’ãƒãƒ³ãƒ‰ãƒ«'))
  * Use suitable binaries\n
    (('note:é©åˆ‡ãªãƒã‚¤ãƒŠãƒªãƒ¼ã‚’ä½¿ã†'))

= Path\n(('note:ãƒ‘ã‚¹'))

  ./lib/hello.rb
  ./lib/2.1/hello.so # For Ruby 2.1
  ./lib/2.2/hello.so # For Ruby 2.2
  ./lib/2.3/hello.so # For Ruby 2.3

= Load\n(('note:èª­ã¿è¾¼ã¿'))

  # coderay ruby
  # hello.rb
  begin
    major, minor, = RUBY_VERSION.split(".")
    # e.g.: require "2.3/hello.so"
    require "#{major}.#{minor}/hello.so"
  rescue LoadError
    require "hello.so"
  end

= Paths for bindings\n(('note:ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã®æ™‚ã®ãƒ‘ã‚¹'))

  ./lib/hello.rb
  ./lib/2.1/hello.so # For Ruby 2.1
  ./lib/2.2/hello.so # For Ruby 2.2
  ./lib/2.3/hello.so # For Ruby 2.3
  # â†“Target library's DLL
  ./vendor/local/bin/hello.dll

= Load for bindings\n(('note:ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã®æ™‚ã®èª­ã¿è¾¼ã¿'))

  # coderay ruby
  # hello.rb
  if /mingw|mswin/ =~ RUBY_PLATFORM
    ENV["PATH"] += # For finding DLL
      ";#{__dir__}\\..\\vendor\\local\\bin"
  end
  begin
    major, minor, = RUBY_VERSION.split(".")
    # ...

= How to create\n(('note:ä½œã‚Šæ–¹'))

  (1) (('wait'))Build DLLs\n
      (('note:DLLã‚’ãƒ“ãƒ«ãƒ‰'))
  (2) (('wait'))Bundle DLLs to gem\n
      (('note:gemã«DLLã‚’ãƒãƒ³ãƒ‰ãƒ«'))

= How to build\n(('note:ãƒ“ãƒ«ãƒ‰æ–¹æ³•'))

  * (('wait'))Build on Windows with C compiler\n
    (('note:Windowsä¸Šã§Cã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ¼ã§ãƒ“ãƒ«ãƒ‰'))
  * (('wait'))Build on GNU/Linux or OS X with C cross compiler\n
    (('note:GNU/Linuxã¾ãŸã¯OS Xä¸Šã§Cã‚¯ãƒ­ã‚¹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ¼ã§ãƒ“ãƒ«ãƒ‰'))
    * Popular\n
      (('note:ã“ã¡ã‚‰ãŒä¸€èˆ¬çš„'))

= How to cross compile\n(('note:ã‚¯ãƒ­ã‚¹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ–¹æ³•'))

  (1) Cross compile target Rubyies\n
      (('note:å¯¾è±¡ã®Rubyã‚’ã‚¯ãƒ­ã‚¹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«'))
  (2) Run (({extconf.rb})) with target Rubies\n
      (('note:å¯¾è±¡ã®Rubyã§(({extconf.rb}))ã‚’å®Ÿè¡Œ'))
  (3) Cross compile\n
      (('note:ã‚¯ãƒ­ã‚¹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«'))

= Fat gem helper gems\n(('note:fat gemä½œæˆæ”¯æ´gem'))

  * rake-compiler
    * Cross compiling and bundling\n
      (('note:ã‚¯ãƒ­ã‚¹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã¨ãƒãƒ³ãƒ‰ãƒ«æ”¯æ´'))
  * rake-compiler-dock
    * Prepares build environment\n
      (('note:ãƒ“ãƒ«ãƒ‰ç’°å¢ƒç”¨æ„æ”¯æ´'))

= Fat gem and bindings\n(('note:fat gemã¨ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°'))

  * Bindings need DLL of target library\n
    (('note:ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã¯å¯¾è±¡ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã®DLLã‚‚å¿…è¦'))
  * Target library should be also cross compiled\n
    (('note:å¯¾è±¡ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã‚‚ã‚¯ãƒ­ã‚¹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒå¿…è¦'))

= How to cross compile1\n(('note:ã‚¯ãƒ­ã‚¹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ–¹æ³•1'))

For GNU Autotools:

  % ./configure \
      --prefix=vendor/local \
      --host=x86_64-w64-mingw32
  % make
  % make install

= How to cross compile2\n(('note:ã‚¯ãƒ­ã‚¹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ–¹æ³•2'))

For CMake:

  % cmake . \
      -DCMAKE_INSTALL_PREFIX=vendor/local \
      -DCMAKE_SYSTEM_NAME=Windows \
      -DCMAKE_SYSTEM_PROCESSOR=x64 \
      -DCMAKE_C_COMPILER=x86_64-w64-mingw32-gcc
  % make
  % make install

= How to bundle\n(('note:ãƒãƒ³ãƒ‰ãƒ«æ–¹æ³•'))

  # coderay ruby
  # #{gem_name}.gemspec
  Rake::ExtensionTask.new(gem_name, spec) do |ext|
    # ...
    ext.cross_compiling do |cross_spec|
      cross_spec.files +=
        Dir.glob("vendor/local/**/*")
    end
  end

= How to build gem\n(('note:gemã®ãƒ“ãƒ«ãƒ‰æ–¹æ³•'))

  % rake cross native gem

= How to release gem\n(('note:gemã®ãƒªãƒªãƒ¼ã‚¹æ–¹æ³•'))

  % gem push pkg/...-x64-mingw32.gem

= How to install fat gem\n(('note:fat gemã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•'))

  > gem install GEM_NAME

No special options\n
(('note:ç‰¹åˆ¥ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ãªã„'))
